<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GAS EXPRESS ‚Äî Sistema de Rutas</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=Barlow:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --red:      #d32f2f;
  --red-dark: #8b0000;
  --red-glow: rgba(211,47,47,0.3);
  --red-dim:  rgba(211,47,47,0.12);
  --bg:       #111111;
  --surface:  #1a1a1a;
  --surface2: #222222;
  --surface3: #2a2a2a;
  --border:   #2e2e2e;
  --border2:  #3a3a3a;
  --text:     #f0f0f0;
  --muted:    #888;
  --orange:   #ff6d00;
  --orange-dim: rgba(255,109,0,0.15);
  --green:    #00c853;
  --green-dim: rgba(0,200,83,0.12);
  --blue:     #2196f3;
}

body {
  font-family: 'Barlow', sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
#sidebar {
  width: 300px;
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  flex-shrink: 0;
  position: relative;
  z-index: 1000;
  transition: width 0.35s cubic-bezier(0.4,0,0.2,1);
}
#sidebar.collapsed { width: 0; border-right: none; }

#toggle-tab {
  position: absolute;
  top: 50%;
  left: 300px;
  transform: translateY(-50%);
  width: 26px; height: 60px;
  background: var(--red);
  border: none;
  border-radius: 0 10px 10px 0;
  cursor: pointer;
  z-index: 1001;
  display: flex; align-items: center; justify-content: center;
  transition: left 0.35s cubic-bezier(0.4,0,0.2,1), background 0.2s;
  box-shadow: 3px 0 14px rgba(0,0,0,0.5);
}
#toggle-tab:hover { background: #b71c1c; }
#toggle-tab .arrow { color:#fff; font-size:13px; transition: transform 0.35s; pointer-events:none; line-height:1; }
#toggle-tab.open { left: 0; }
#toggle-tab.open .arrow { transform: rotate(180deg); }

.sidebar-header {
  background: var(--red-dark);
  padding: 18px 16px 14px;
  border-bottom: 3px solid var(--red);
  position: relative;
  overflow: hidden;
  flex-shrink: 0;
}
.sidebar-header::before {
  content:''; position:absolute; top:-20px; right:-20px;
  width:100px; height:100px; background: var(--red-glow);
  border-radius:50%; filter:blur(30px);
}
.brand { font-family:'Barlow Condensed',sans-serif; font-size:28px; font-weight:800; letter-spacing:3px; color:#fff; line-height:1; }
.brand-sub { font-size:10px; letter-spacing:4px; text-transform:uppercase; color:rgba(255,255,255,0.5); margin-top:2px; }

/* Tabs */
.tab-bar {
  display: flex;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  background: var(--surface);
}
.tab-btn {
  flex: 1;
  padding: 10px 4px;
  background: transparent;
  border: none;
  color: var(--muted);
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}
.tab-btn:hover { color: var(--text); }
.tab-btn.active { color: var(--red); border-bottom-color: var(--red); }

.tab-panel { display: none; flex: 1; overflow-y: auto; flex-direction: column; }
.tab-panel.active { display: flex; }
.tab-panel::-webkit-scrollbar { width: 4px; }
.tab-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius:2px; }

.panel-body { padding: 14px; flex: 1; overflow-y: auto; }
.panel-body::-webkit-scrollbar { width: 4px; }
.panel-body::-webkit-scrollbar-thumb { background: var(--border); border-radius:2px; }

.section-label {
  font-size: 9px; letter-spacing: 3px; text-transform: uppercase;
  color: var(--muted); margin-bottom: 8px; padding-bottom: 5px;
  border-bottom: 1px solid var(--border);
}

/* Base selector pill */
.base-selector {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px 12px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}
.base-selector:hover { border-color: var(--orange); }
.base-selector.active-base { border-color: var(--orange); background: var(--orange-dim); }
.base-dot {
  width: 10px; height: 10px; border-radius: 50%;
  flex-shrink: 0;
}
.base-info { flex: 1; min-width: 0; }
.base-name { font-family:'Barlow Condensed',sans-serif; font-size:14px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.base-addr { font-size:10px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.base-actions { display:flex; gap:4px; }
.icon-btn {
  width:24px; height:24px; border-radius:4px; border:1px solid var(--border);
  background: var(--surface3); color: var(--muted); font-size:11px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; transition:all 0.2s; flex-shrink:0;
}
.icon-btn:hover.edit-icon { border-color:#2196f3; color:#2196f3; background:rgba(33,150,243,0.1); }
.icon-btn:hover.del-icon  { border-color:var(--red); color:var(--red); background: var(--red-dim); }
.base-active-tag {
  font-size:9px; letter-spacing:1px; text-transform:uppercase;
  color: var(--orange); background: var(--orange-dim);
  border:1px solid rgba(255,109,0,0.3); border-radius:3px;
  padding: 2px 5px; white-space:nowrap;
}

/* Route buttons */
.route-btn {
  width:100%; background:var(--surface2); color:var(--text);
  border:1px solid var(--border); padding:10px 12px;
  margin-bottom:6px; cursor:pointer;
  font-family:'Barlow Condensed',sans-serif; font-size:15px; font-weight:600;
  letter-spacing:1px; border-radius:8px; transition:all 0.2s;
  display:flex; align-items:center; gap:8px; text-align:left;
  position:relative; overflow:hidden;
}
.route-btn::after {
  content:''; position:absolute; left:0; top:0; bottom:0; width:3px;
  background:var(--red); opacity:0; transition:opacity 0.2s;
}
.route-btn:hover { background:#2a2a2a; border-color:var(--red); transform:translateX(2px); }
.route-btn:hover::after { opacity:1; }
.route-btn.active { background:var(--red-dim); border-color:var(--red); }
.route-btn.active::after { opacity:1; }

.btn-meta { flex:1; display:flex; flex-direction:column; gap:2px; min-width:0; }
.btn-name { font-size:14px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.btn-dist { font-size:11px; color:var(--muted); font-family:'Barlow',sans-serif; font-weight:400; }

.optimized-btn {
  width:100%; background:var(--red); color:#fff; border:none;
  padding:12px; cursor:pointer; font-family:'Barlow Condensed',sans-serif;
  font-size:16px; font-weight:700; letter-spacing:2px; border-radius:8px;
  margin-top:4px; transition:all 0.2s; display:flex; align-items:center;
  justify-content:center; gap:8px;
}
.optimized-btn:hover { background:#b71c1c; transform:translateY(-1px); box-shadow:0 6px 20px var(--red-glow); }

.clear-btn {
  width:100%; background:transparent; border:1px solid var(--border);
  color:var(--muted); padding:8px; cursor:pointer;
  font-family:'Barlow',sans-serif; font-size:12px; border-radius:8px;
  margin-top:6px; transition:all 0.2s;
}
.clear-btn:hover { border-color:#555; color:var(--text); }

/* Info panel */
#info-panel { margin-top:14px; display:none; }
.info-card { background:var(--surface2); border:1px solid var(--border); border-radius:10px; padding:14px; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:translateY(0)} }
.info-title { font-family:'Barlow Condensed',sans-serif; font-size:13px; letter-spacing:2px; text-transform:uppercase; color:var(--red); margin-bottom:10px; }
.info-stats { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px; }
.stat-box { background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:10px; text-align:center; }
.stat-val { font-family:'Barlow Condensed',sans-serif; font-size:22px; font-weight:700; color:var(--text); line-height:1; }
.stat-val span { font-size:12px; color:var(--muted); }
.stat-label { font-size:10px; color:var(--muted); margin-top:3px; letter-spacing:1px; text-transform:uppercase; }
.steps-list { list-style:none; }
.step-item { display:flex; gap:10px; align-items:flex-start; padding:6px 0; border-bottom:1px solid var(--border); font-size:12px; line-height:1.4; }
.step-item:last-child { border-bottom:none; }
.step-n { width:18px;height:18px;border-radius:50%;background:var(--red-dim);border:1px solid var(--red);display:flex;align-items:center;justify-content:center;font-size:9px;color:var(--red);flex-shrink:0;margin-top:1px; }
.step-d { color:var(--muted); font-size:11px; margin-top:2px; }
.stop-row { display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--border);font-size:12px; }
.stop-row:last-child { border-bottom:none; }
.stop-dot { width:8px;height:8px;border-radius:50%;flex-shrink:0; }
.stop-km { margin-left:auto; color:var(--muted); font-size:11px; white-space:nowrap; }

.loading { display:flex;flex-direction:column;align-items:center;gap:10px;padding:20px;color:var(--muted);font-size:13px; }
.spin { width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--red);border-radius:50%;animation:spin 0.7s linear infinite; }
@keyframes spin { to{transform:rotate(360deg)} }

/* ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ */
.admin-section { margin-bottom:20px; }
.add-btn {
  width:100%; background:transparent; border:1px dashed var(--border2);
  color:var(--muted); padding:10px; cursor:pointer;
  font-family:'Barlow',sans-serif; font-size:13px; border-radius:8px;
  transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:6px;
  margin-top:6px;
}
.add-btn:hover { border-color:var(--red); color:var(--red); background:var(--red-dim); }
.add-btn.green:hover { border-color:var(--green); color:var(--green); background:var(--green-dim); }

/* Form */
.form-panel {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 14px;
  margin-bottom: 12px;
  animation: fadeIn 0.25s ease;
}
.form-title {
  font-family:'Barlow Condensed',sans-serif; font-size:13px; letter-spacing:2px;
  text-transform:uppercase; margin-bottom:12px; display:flex; align-items:center; justify-content:space-between;
}
.form-title .close-form { color:var(--muted); cursor:pointer; font-size:16px; line-height:1; transition:color 0.2s; }
.form-title .close-form:hover { color:var(--text); }

.form-group { margin-bottom:10px; }
.form-label { font-size:10px; letter-spacing:1.5px; text-transform:uppercase; color:var(--muted); margin-bottom:5px; display:block; }
.form-input {
  width:100%; background:var(--bg); border:1px solid var(--border);
  border-radius:6px; padding:9px 11px; color:var(--text);
  font-family:'Barlow',sans-serif; font-size:13px;
  transition: border-color 0.2s; outline:none;
}
.form-input:focus { border-color:var(--red); }
.form-input::placeholder { color:#444; }

.coord-row { display:grid; grid-template-columns:1fr 1fr; gap:8px; }

.form-hint {
  font-size:10px; color:var(--muted); margin-top:4px; line-height:1.4;
}

.color-row { display:flex; gap:6px; flex-wrap:wrap; margin-top:4px; }
.color-swatch {
  width:22px; height:22px; border-radius:50%; cursor:pointer;
  border:2px solid transparent; transition:all 0.2s; flex-shrink:0;
}
.color-swatch:hover { transform:scale(1.2); }
.color-swatch.selected { border-color:#fff; box-shadow:0 0 8px rgba(255,255,255,0.4); }

.map-pick-btn {
  width:100%; background:rgba(33,150,243,0.1); border:1px solid rgba(33,150,243,0.3);
  color:#64b5f6; padding:8px; cursor:pointer; font-size:12px; border-radius:6px;
  transition:all 0.2s; margin-bottom:6px; font-family:'Barlow',sans-serif;
}
.map-pick-btn:hover { background:rgba(33,150,243,0.2); border-color:#2196f3; color:#90caf9; }
.map-pick-btn.picking { background:rgba(33,150,243,0.25); border-color:#2196f3; animation: pulse-blue 1s ease-in-out infinite; }
@keyframes pulse-blue { 0%,100%{box-shadow:0 0 0 0 rgba(33,150,243,0.4)} 50%{box-shadow:0 0 0 6px rgba(33,150,243,0)} }

.form-actions { display:flex; gap:6px; margin-top:12px; }
.btn-save {
  flex:1; background:var(--red); color:#fff; border:none; padding:9px;
  border-radius:6px; font-family:'Barlow Condensed',sans-serif;
  font-size:14px; font-weight:700; letter-spacing:1px; cursor:pointer; transition:all 0.2s;
}
.btn-save:hover { background:#b71c1c; }
.btn-save.green-save { background:var(--green); color:#111; }
.btn-save.green-save:hover { background:#00a844; }
.btn-cancel { background:transparent; border:1px solid var(--border); color:var(--muted); padding:9px 14px; border-radius:6px; font-size:13px; cursor:pointer; transition:all 0.2s; }
.btn-cancel:hover { border-color:#555; color:var(--text); }

/* Admin item rows */
.admin-item {
  display:flex; align-items:center; gap:8px; padding:8px 10px;
  background:var(--surface2); border:1px solid var(--border);
  border-radius:8px; margin-bottom:5px; transition:border-color 0.2s;
}
.admin-item:hover { border-color:var(--border2); }
.admin-item-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.admin-item-info { flex:1; min-width:0; }
.admin-item-name { font-size:13px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.admin-item-sub { font-size:10px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.admin-item-btns { display:flex; gap:4px; flex-shrink:0; }

/* MAP */
#map { flex:1; z-index:1; }
#map.picking-mode { cursor: crosshair !important; }

.leaflet-popup-content-wrapper { background:var(--surface2)!important; color:var(--text)!important; border:1px solid var(--border)!important; border-radius:8px!important; box-shadow:0 8px 24px rgba(0,0,0,0.6)!important; font-family:'Barlow',sans-serif!important; font-size:13px!important; }
.leaflet-popup-tip { background:var(--surface2)!important; }
.leaflet-popup-close-button { color:var(--muted)!important; }

/* Status bar */
#statusbar {
  position:absolute; bottom:0; left:300px; right:0; height:32px;
  background:rgba(17,17,17,0.95); border-top:1px solid var(--border);
  display:flex; align-items:center; padding:0 16px; gap:16px;
  font-size:11px; color:var(--muted); z-index:999;
  transition: left 0.35s cubic-bezier(0.4,0,0.2,1);
}
#statusbar.expanded { left:0; }
.status-dot { width:6px;height:6px;border-radius:50%;background:var(--red);animation:blink 1.5s ease-in-out infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

/* Picking banner */
#pick-banner {
  position:absolute; top:16px; left:50%; transform:translateX(-50%);
  background:rgba(33,150,243,0.9); color:#fff; padding:8px 20px;
  border-radius:20px; font-size:13px; font-family:'Barlow Condensed',sans-serif;
  font-weight:600; letter-spacing:1px; z-index:2000; display:none;
  box-shadow:0 4px 20px rgba(0,0,0,0.5); pointer-events:none;
}

/* Confirm / alert modal */
#modal-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.7);
  display:none; align-items:center; justify-content:center; z-index:9999;
}
#modal-overlay.show { display:flex; }
.modal-box {
  background:var(--surface2); border:1px solid var(--border); border-radius:12px;
  padding:24px; width:320px; animation:fadeIn 0.2s ease;
}
.modal-title { font-family:'Barlow Condensed',sans-serif; font-size:18px; font-weight:700; margin-bottom:8px; }
.modal-msg { font-size:13px; color:var(--muted); margin-bottom:18px; line-height:1.6; }
.modal-actions { display:flex; gap:8px; justify-content:flex-end; }
.modal-btn { padding:8px 18px; border-radius:6px; font-size:13px; cursor:pointer; border:none; font-family:'Barlow',sans-serif; font-weight:500; transition:all 0.2s; }
.modal-btn.cancel { background:transparent; border:1px solid var(--border); color:var(--muted); }
.modal-btn.cancel:hover { border-color:#555; color:var(--text); }
.modal-btn.confirm { background:var(--red); color:#fff; }
.modal-btn.confirm:hover { background:#b71c1c; }

/* scrollable route tab body */
#tab-routes .panel-body { overflow-y: auto; }
</style>
</head>
<body>

<!-- SIDEBAR -->
<div id="sidebar">
  <div class="sidebar-header">
    <div class="brand">‚õΩ GAS EXPRESS</div>
    <div class="brand-sub">Sistema de Rutas ¬∑ Guanajuato</div>
  </div>

  <div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('routes')" id="tabBtn-routes">RUTAS</button>
    <button class="tab-btn" onclick="switchTab('bases')"  id="tabBtn-bases">BASES</button>
    <button class="tab-btn" onclick="switchTab('dests')"  id="tabBtn-dests">DESTINOS</button>
  </div>

  <!-- ‚îÄ‚îÄ TAB RUTAS ‚îÄ‚îÄ -->
  <div class="tab-panel active" id="tab-routes">
    <div class="panel-body">

      <div class="section-label" style="margin-top:2px;">Base activa</div>
      <div id="active-base-display" style="margin-bottom:14px;"></div>

      <div class="section-label">Rutas individuales</div>
      <div id="dest-buttons"></div>

      <div class="section-label" style="margin-top:10px;">Ruta optimizada</div>
      <button class="optimized-btn" onclick="routeOptimized()">üó∫ RUTA COMPLETA √ìPTIMA</button>
      <button class="clear-btn" onclick="clearAll()">‚úï Limpiar mapa</button>

      <div id="info-panel">
        <div class="section-label" style="margin-top:14px;">Resultado</div>
        <div class="info-card" id="info-card">
          <div class="loading" id="loading-indicator"><div class="spin"></div>Calculando ruta...</div>
          <div id="info-content" style="display:none;"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- ‚îÄ‚îÄ TAB BASES ‚îÄ‚îÄ -->
  <div class="tab-panel" id="tab-bases">
    <div class="panel-body">
      <div class="section-label" style="margin-top:2px;">Bases principales</div>
      <div id="bases-list"></div>

      <div id="base-form-container"></div>

      <button class="add-btn green" onclick="showBaseForm()">Ôºã AGREGAR NUEVA BASE</button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ TAB DESTINOS ‚îÄ‚îÄ -->
  <div class="tab-panel" id="tab-dests">
    <div class="panel-body">
      <div class="section-label" style="margin-top:2px;">Destinos / Sucursales</div>
      <div id="dests-list"></div>

      <div id="dest-form-container"></div>

      <button class="add-btn" onclick="showDestForm()">Ôºã AGREGAR NUEVO DESTINO</button>
    </div>
  </div>

</div>

<!-- TOGGLE TAB -->
<button id="toggle-tab" onclick="toggleSidebar()" title="Abrir/cerrar men√∫">
  <span class="arrow">‚óÄ</span>
</button>

<!-- MAP -->
<div id="map"></div>

<!-- Pick banner -->
<div id="pick-banner">üìç Haz clic en el mapa para seleccionar la ubicaci√≥n</div>

<!-- STATUS BAR -->
<div id="statusbar">
  <span><span class="status-dot"></span> OSRM Online</span>
  <span id="status-msg">Selecciona una ruta para comenzar</span>
</div>

<!-- CONFIRM MODAL -->
<div id="modal-overlay">
  <div class="modal-box">
    <div class="modal-title" id="modal-title">¬øConfirmar?</div>
    <div class="modal-msg" id="modal-msg"></div>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeModal()">Cancelar</button>
      <button class="modal-btn confirm" id="modal-confirm-btn">Eliminar</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIREBASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const firebaseConfig = {
  apiKey: "AIzaSyAGqZ5PU4QIA0Kyjd1ikPSsrgKFes-tTS8",
  authDomain: "gas-express-rutas.firebaseapp.com",
  projectId: "gas-express-rutas",
  storageBucket: "gas-express-rutas.firebasestorage.app",
  messagingSenderId: "1074853104826",
  appId: "1:1074853104826:web:ae67053cd5f3b902724683",
  measurementId: "G-Y52NL73VVF"
};

const fbApp    = initializeApp(firebaseConfig);
const db       = getFirestore(fbApp);
const STATE_DOC = doc(db, "config", "state");

async function saveState() {
  try {
    await setDoc(STATE_DOC, {
      bases:        state.bases,
      destinations: state.destinations,
      activeBaseId: state.activeBaseId,
    });
  } catch(e) {
    console.error("Error guardando en Firestore:", e);
    setStatus("‚ö†Ô∏è Error al guardar en Firebase");
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE (valores por defecto ‚Äî se sobreescriben con Firestore)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const COLORS = ['#ff6d00','#d32f2f','#9c27b0','#1565c0','#00695c','#f57f17','#4caf50','#e91e63','#00bcd4','#ff5722'];

let state = {
  bases: [
    { id: 'b1', name: 'Le√≥n ‚Äî Industrial Delta', address: 'C. Zeta 101, Industrial Delta', coords: [-101.6581, 21.1019], color: '#ff6d00' },
    { id: 'b2', name: 'Le√≥n ‚Äî Plaza Mayor',      address: 'Blvd. Torres Landa 1980',      coords: [-101.6890, 21.1220], color: '#ff9800' },
  ],
  destinations: [
    { id: 'd1', name: 'Base Silao',     address: 'Silao, Gto.',     coords: [-101.4284, 20.9551], color: '#ef5350' },
    { id: 'd2', name: 'Base Irapuato',  address: 'Irapuato, Gto.',  coords: [-101.3412, 20.6764], color: '#ef5350' },
    { id: 'd3', name: 'Base Salamanca', address: 'Salamanca, Gto.', coords: [-101.1960, 20.5697], color: '#ef5350' },
    { id: 'd4', name: 'Celaya',         address: 'Celaya, Gto.',    coords: [-100.8175, 20.5238], color: '#ef5350' },
  ],
  activeBaseId: 'b1',
};

let routeLayer   = null;
let activeBtn    = null;
let allMarkers   = [];
let pickingMode  = null;
let pickCallback = null;
let editingBaseId = null;
let editingDestId = null;
let _firebaseReady = false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAP INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const map = L.map('map', { zoomControl: false }).setView([20.9, -101.2], 9);
L.control.zoom({ position: 'bottomright' }).addTo(map);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '¬© OpenStreetMap, ¬© CartoDB', maxZoom: 18
}).addTo(map);

map.on('click', function(e) {
  if (!pickingMode || !pickCallback) return;
  pickCallback(e.latlng.lng, e.latlng.lat);
  stopPicking();
});

function startPicking(mode, callback) {
  pickingMode = mode; pickCallback = callback;
  map.getContainer().classList.add('picking-mode');
  document.getElementById('pick-banner').style.display = 'block';
}
function stopPicking() {
  pickingMode = null; pickCallback = null;
  map.getContainer().classList.remove('picking-mode');
  document.getElementById('pick-banner').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER MARKERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMarkers() {
  allMarkers.forEach(m => map.removeLayer(m));
  allMarkers = [];

  state.bases.forEach(base => {
    const isActive = base.id === state.activeBaseId;
    const icon = L.divIcon({
      html: `<div style="background:${base.color};width:${isActive?18:12}px;height:${isActive?18:12}px;border-radius:50%;border:${isActive?'3px':'2px'} solid #fff;box-shadow:0 0 ${isActive?'16':'8'}px ${base.color};"></div>`,
      className:'', iconAnchor: isActive ? [9,9] : [6,6]
    });
    const m = L.marker([base.coords[1], base.coords[0]], { icon })
      .addTo(map)
      .bindPopup(`<strong style="color:${base.color}">üè† ${base.name}</strong><br><small>${base.address}</small>${isActive?'<br><span style="color:#ff6d00;font-size:11px;font-weight:600">‚ñ∂ BASE ACTIVA</span>':''}`);
    allMarkers.push(m);
  });

  state.destinations.forEach(dest => {
    const icon = L.divIcon({
      html: `<div style="background:${dest.color};width:12px;height:12px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 8px ${dest.color};"></div>`,
      className:'', iconAnchor:[6,6]
    });
    const m = L.marker([dest.coords[1], dest.coords[0]], { icon })
      .addTo(map)
      .bindPopup(`<strong style="color:${dest.color}">üìç ${dest.name}</strong><br><small>${dest.address}</small>`);
    allMarkers.push(m);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER ‚Äî ROUTES TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderRoutesTab() {
  const activeBase = state.bases.find(b => b.id === state.activeBaseId) || state.bases[0];
  const abDiv = document.getElementById('active-base-display');
  if (activeBase) {
    abDiv.innerHTML = `
      <div style="background:var(--orange-dim);border:1px solid rgba(255,109,0,0.4);border-radius:10px;padding:12px 14px;display:flex;gap:10px;align-items:center;">
        <div style="width:12px;height:12px;border-radius:50%;background:${activeBase.color};box-shadow:0 0 8px ${activeBase.color};flex-shrink:0;"></div>
        <div style="flex:1;min-width:0;">
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;">${activeBase.name}</div>
          <div style="font-size:10px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${activeBase.address}</div>
        </div>
        <button onclick="switchTab('bases')" style="background:transparent;border:1px solid rgba(255,109,0,0.4);color:#ff9800;padding:4px 8px;border-radius:5px;font-size:10px;cursor:pointer;font-family:'Barlow',sans-serif;letter-spacing:1px;">CAMBIAR</button>
      </div>`;
  }

  const container = document.getElementById('dest-buttons');
  container.innerHTML = '';
  state.destinations.forEach(dest => {
    const btn = document.createElement('button');
    btn.className = 'route-btn';
    btn.id = 'routebtn-' + dest.id;
    btn.innerHTML = `
      <div style="width:28px;height:28px;border-radius:50%;background:rgba(211,47,47,0.2);display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;">üìç</div>
      <div class="btn-meta">
        <span class="btn-name">${dest.name}</span>
        <span class="btn-dist" id="dist-${dest.id}">Calculando...</span>
      </div>`;
    btn.onclick = () => routeTo(dest.id);
    container.appendChild(btn);
  });

  if (state.destinations.length === 0) {
    container.innerHTML = `<div style="text-align:center;color:var(--muted);font-size:12px;padding:16px;">Sin destinos. Agr√©galos en la pesta√±a DESTINOS.</div>`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER ‚Äî BASES TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBasesTab() {
  const list = document.getElementById('bases-list');
  list.innerHTML = '';
  state.bases.forEach(base => {
    const isActive = base.id === state.activeBaseId;
    const row = document.createElement('div');
    row.className = 'admin-item';
    row.style.borderColor = isActive ? 'rgba(255,109,0,0.5)' : '';
    row.innerHTML = `
      <div class="admin-item-dot" style="background:${base.color};box-shadow:0 0 6px ${base.color};"></div>
      <div class="admin-item-info" onclick="setActiveBase('${base.id}')" style="cursor:pointer;">
        <div class="admin-item-name">${base.name} ${isActive ? '<span style="color:var(--orange);font-size:10px;">(activa)</span>' : ''}</div>
        <div class="admin-item-sub">${base.address}</div>
      </div>
      <div class="admin-item-btns">
        ${!isActive ? `<button class="icon-btn" onclick="setActiveBase('${base.id}')" title="Usar como base activa" style="font-size:13px;">üéØ</button>` : ''}
        <button class="icon-btn edit-icon" onclick="showBaseForm('${base.id}')" title="Editar">‚úèÔ∏è</button>
        ${state.bases.length > 1 ? `<button class="icon-btn del-icon" onclick="confirmDeleteBase('${base.id}')" title="Eliminar">üóë</button>` : ''}
      </div>`;
    list.appendChild(row);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER ‚Äî DESTS TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDestsTab() {
  const list = document.getElementById('dests-list');
  list.innerHTML = '';
  state.destinations.forEach(dest => {
    const row = document.createElement('div');
    row.className = 'admin-item';
    row.innerHTML = `
      <div class="admin-item-dot" style="background:${dest.color};box-shadow:0 0 5px ${dest.color};"></div>
      <div class="admin-item-info">
        <div class="admin-item-name">${dest.name}</div>
        <div class="admin-item-sub">${dest.address}</div>
      </div>
      <div class="admin-item-btns">
        <button class="icon-btn edit-icon" onclick="showDestForm('${dest.id}')" title="Editar">‚úèÔ∏è</button>
        <button class="icon-btn del-icon" onclick="confirmDeleteDest('${dest.id}')" title="Eliminar">üóë</button>
      </div>`;
    list.appendChild(row);
  });
  if (state.destinations.length === 0) {
    list.innerHTML = `<div style="text-align:center;color:var(--muted);font-size:12px;padding:16px;">Sin destinos registrados.</div>`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BASE FORM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.showBaseForm = function(id) {
  editingBaseId = id || null;
  const base = id ? state.bases.find(b => b.id === id) : null;
  const container = document.getElementById('base-form-container');
  const colorSwatches = COLORS.map(c => `<div class="color-swatch${base && base.color===c?' selected':(!base&&c===COLORS[0]?' selected':'')}" style="background:${c};" data-color="${c}" onclick="selectColor(this,'base')"></div>`).join('');
  container.innerHTML = `
    <div class="form-panel">
      <div class="form-title">
        <span style="color:var(--green);">${id ? '‚úèÔ∏è EDITAR BASE' : 'Ôºã NUEVA BASE'}</span>
        <span class="close-form" onclick="hideBaseForm()">‚úï</span>
      </div>
      <div class="form-group">
        <label class="form-label">Nombre de la base</label>
        <input class="form-input" id="base-input-name" placeholder="Ej: Le√≥n Norte" value="${base ? base.name : ''}">
      </div>
      <div class="form-group">
        <label class="form-label">Direcci√≥n / Referencia</label>
        <input class="form-input" id="base-input-addr" placeholder="Ej: Av. Insurgentes 400" value="${base ? base.address : ''}">
      </div>
      <div class="form-group">
        <label class="form-label">Color</label>
        <div class="color-row" id="base-color-row">${colorSwatches}</div>
      </div>
      <div class="form-group">
        <label class="form-label">Coordenadas</label>
        <button class="map-pick-btn" id="base-pick-btn" onclick="pickOnMap('base')">üìç Seleccionar en el mapa</button>
        <div class="coord-row">
          <div><label class="form-label">Latitud</label><input class="form-input" id="base-input-lat" placeholder="21.1019" value="${base ? base.coords[1] : ''}"></div>
          <div><label class="form-label">Longitud</label><input class="form-input" id="base-input-lng" placeholder="-101.6581" value="${base ? base.coords[0] : ''}"></div>
        </div>
        <div class="form-hint">Haz clic en el bot√≥n para marcar en el mapa, o escribe las coordenadas.</div>
      </div>
      <div class="form-actions">
        <button class="btn-cancel" onclick="hideBaseForm()">Cancelar</button>
        <button class="btn-save green-save" onclick="saveBase()">üíæ GUARDAR</button>
      </div>
    </div>`;
  if (base) {
    document.querySelectorAll('#base-color-row .color-swatch').forEach(s => s.classList.toggle('selected', s.dataset.color === base.color));
  }
  switchTab('bases');
}

window.hideBaseForm = function() {
  document.getElementById('base-form-container').innerHTML = '';
  editingBaseId = null; stopPicking();
}

window.saveBase = async function() {
  const name  = document.getElementById('base-input-name').value.trim();
  const addr  = document.getElementById('base-input-addr').value.trim();
  const lat   = parseFloat(document.getElementById('base-input-lat').value);
  const lng   = parseFloat(document.getElementById('base-input-lng').value);
  const colorEl = document.querySelector('#base-color-row .color-swatch.selected');
  const color = colorEl ? colorEl.dataset.color : '#ff6d00';
  if (!name) { alert('Ingresa un nombre para la base.'); return; }
  if (isNaN(lat) || isNaN(lng)) { alert('Ingresa coordenadas v√°lidas.'); return; }
  if (editingBaseId) {
    const b = state.bases.find(x => x.id === editingBaseId);
    b.name = name; b.address = addr; b.coords = [lng, lat]; b.color = color;
  } else {
    state.bases.push({ id: 'b' + Date.now(), name, address: addr, coords: [lng, lat], color });
  }
  hideBaseForm();
  await saveState();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DEST FORM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.showDestForm = function(id) {
  editingDestId = id || null;
  const dest = id ? state.destinations.find(d => d.id === id) : null;
  const container = document.getElementById('dest-form-container');
  const colorSwatches = COLORS.map(c => `<div class="color-swatch${dest && dest.color===c?' selected':(!dest&&c===COLORS[1]?' selected':'')}" style="background:${c};" data-color="${c}" onclick="selectColor(this,'dest')"></div>`).join('');
  container.innerHTML = `
    <div class="form-panel">
      <div class="form-title">
        <span style="color:var(--red);">${id ? '‚úèÔ∏è EDITAR DESTINO' : 'Ôºã NUEVO DESTINO'}</span>
        <span class="close-form" onclick="hideDestForm()">‚úï</span>
      </div>
      <div class="form-group">
        <label class="form-label">Nombre del destino</label>
        <input class="form-input" id="dest-input-name" placeholder="Ej: Base Guanajuato" value="${dest ? dest.name : ''}">
      </div>
      <div class="form-group">
        <label class="form-label">Direcci√≥n / Referencia</label>
        <input class="form-input" id="dest-input-addr" placeholder="Ej: Centro, Guanajuato" value="${dest ? dest.address : ''}">
      </div>
      <div class="form-group">
        <label class="form-label">Color del marcador</label>
        <div class="color-row" id="dest-color-row">${colorSwatches}</div>
      </div>
      <div class="form-group">
        <label class="form-label">Coordenadas</label>
        <button class="map-pick-btn" id="dest-pick-btn" onclick="pickOnMap('dest')">üìç Seleccionar en el mapa</button>
        <div class="coord-row">
          <div><label class="form-label">Latitud</label><input class="form-input" id="dest-input-lat" placeholder="20.9551" value="${dest ? dest.coords[1] : ''}"></div>
          <div><label class="form-label">Longitud</label><input class="form-input" id="dest-input-lng" placeholder="-101.4284" value="${dest ? dest.coords[0] : ''}"></div>
        </div>
        <div class="form-hint">Haz clic en el bot√≥n para marcar en el mapa, o escribe las coordenadas.</div>
      </div>
      <div class="form-actions">
        <button class="btn-cancel" onclick="hideDestForm()">Cancelar</button>
        <button class="btn-save" onclick="saveDest()">üíæ GUARDAR</button>
      </div>
    </div>`;
  if (dest) {
    document.querySelectorAll('#dest-color-row .color-swatch').forEach(s => s.classList.toggle('selected', s.dataset.color === dest.color));
  }
  switchTab('dests');
}

window.hideDestForm = function() {
  document.getElementById('dest-form-container').innerHTML = '';
  editingDestId = null; stopPicking();
}

window.saveDest = async function() {
  const name  = document.getElementById('dest-input-name').value.trim();
  const addr  = document.getElementById('dest-input-addr').value.trim();
  const lat   = parseFloat(document.getElementById('dest-input-lat').value);
  const lng   = parseFloat(document.getElementById('dest-input-lng').value);
  const colorEl = document.querySelector('#dest-color-row .color-swatch.selected');
  const color = colorEl ? colorEl.dataset.color : '#ef5350';
  if (!name) { alert('Ingresa un nombre para el destino.'); return; }
  if (isNaN(lat) || isNaN(lng)) { alert('Ingresa coordenadas v√°lidas.'); return; }
  if (editingDestId) {
    const d = state.destinations.find(x => x.id === editingDestId);
    d.name = name; d.address = addr; d.coords = [lng, lat]; d.color = color;
  } else {
    state.destinations.push({ id: 'd' + Date.now(), name, address: addr, coords: [lng, lat], color });
  }
  hideDestForm();
  await saveState();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COLOR PICKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.selectColor = function(el, type) {
  const rowId = type === 'base' ? 'base-color-row' : 'dest-color-row';
  document.querySelectorAll('#' + rowId + ' .color-swatch').forEach(s => s.classList.remove('selected'));
  el.classList.add('selected');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAP PICKING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.pickOnMap = function(type) {
  const btn = document.getElementById(type + '-pick-btn');
  btn.classList.add('picking');
  btn.textContent = '‚è≥ Haz clic en el mapa...';
  startPicking(type, (lng, lat) => {
    document.getElementById(type + '-input-lat').value = lat.toFixed(5);
    document.getElementById(type + '-input-lng').value = lng.toFixed(5);
    btn.classList.remove('picking');
    btn.textContent = '‚úÖ Ubicaci√≥n seleccionada';
    setTimeout(() => { btn.textContent = 'üìç Seleccionar en el mapa'; }, 2000);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SET ACTIVE BASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.setActiveBase = async function(id) {
  state.activeBaseId = id;
  await saveState();
  clearRoute();
  document.getElementById('info-panel').style.display = 'none';
  switchTab('routes');
  const base = state.bases.find(b => b.id === id);
  setStatus(`Base activa: ${base.name}`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DELETE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.confirmDeleteBase = function(id) {
  const base = state.bases.find(b => b.id === id);
  openModal(`Eliminar "${base.name}"`, `¬øEst√°s seguro? Esta base se eliminar√° para todos los usuarios.`, async () => {
    state.bases = state.bases.filter(b => b.id !== id);
    if (state.activeBaseId === id && state.bases.length > 0) state.activeBaseId = state.bases[0].id;
    await saveState();
  });
}

window.confirmDeleteDest = function(id) {
  const dest = state.destinations.find(d => d.id === id);
  openModal(`Eliminar "${dest.name}"`, `¬øEst√°s seguro? Este destino se eliminar√° para todos los usuarios.`, async () => {
    state.destinations = state.destinations.filter(d => d.id !== id);
    await saveState();
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openModal = function(title, msg, onConfirm) {
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-msg').textContent = msg;
  document.getElementById('modal-confirm-btn').onclick = () => { onConfirm(); closeModal(); };
  document.getElementById('modal-overlay').classList.add('show');
}
window.closeModal = function() { document.getElementById('modal-overlay').classList.remove('show'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OSRM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function getRoute(coordsArray) {
  const str = coordsArray.map(c => c.join(",")).join(";");
  const url  = `https://router.project-osrm.org/route/v1/driving/${str}?overview=full&geometries=geojson&steps=true`;
  const res  = await fetch(url);
  const data = await res.json();
  if (!data.routes || data.routes.length === 0) throw new Error("Sin resultados");
  return data.routes[0];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ROUTE TO DEST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.routeTo = async function(destId) {
  clearRoute();
  setActiveRouteBtn('routebtn-' + destId);
  showLoading();
  const dest = state.destinations.find(d => d.id === destId);
  const base = state.bases.find(b => b.id === state.activeBaseId);
  setStatus(`Calculando ruta a ${dest.name}...`);
  try {
    const route = await getRoute([base.coords, dest.coords]);
    drawRoute(route.geometry, dest.color || '#d32f2f');
    const km  = (route.distance / 1000).toFixed(1);
    const min = Math.round(route.duration / 60);
    const el = document.getElementById('dist-' + destId);
    if (el) el.textContent = `${km} km ¬∑ ${min} min`;
    showInfo(dest.name, km, min, [{ name: base.name }, { name: dest.name }], route.legs[0]?.steps || []);
    setStatus(`${dest.name} ‚Äî ${km} km ¬∑ ${min} min`);
    fitRoute(route.geometry);
  } catch(e) {
    showError('Error al calcular la ruta. Verifica tu conexi√≥n.');
    setStatus('Error de conexi√≥n');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OPTIMIZED ROUTE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.routeOptimized = async function() {
  if (state.destinations.length === 0) { showError('No hay destinos registrados.'); return; }
  clearRoute(); setActiveRouteBtn(null); showLoading();
  setStatus('Calculando ruta √≥ptima...');
  const base = state.bases.find(b => b.id === state.activeBaseId);
  try {
    let remaining = [...state.destinations];
    let current   = base.coords;
    let ordered   = [{ name: base.name, coords: current }];
    while (remaining.length > 0) {
      let nearestIdx = 0, shortest = Infinity;
      remaining.forEach((d, i) => {
        const dx = current[0]-d.coords[0], dy = current[1]-d.coords[1];
        if (Math.sqrt(dx*dx+dy*dy) < shortest) { shortest = Math.sqrt(dx*dx+dy*dy); nearestIdx = i; }
      });
      current = remaining[nearestIdx].coords;
      ordered.push(remaining[nearestIdx]);
      remaining.splice(nearestIdx, 1);
    }
    const route = await getRoute(ordered.map(o => o.coords));
    drawRoute(route.geometry, '#d32f2f', true);
    const km  = (route.distance/1000).toFixed(1);
    const min = Math.round(route.duration/60);
    const stopsWithDist = ordered.map((o,i) => ({ name: o.name, km: i < route.legs.length ? (route.legs[i].distance/1000).toFixed(1) : null }));
    showInfo('Ruta Completa √ìptima', km, min, stopsWithDist, []);
    setStatus(`Ruta √≥ptima: ${ordered.slice(1).map(o=>o.name).join(' ‚Üí ')} ‚Äî ${km} km`);
    fitRoute(route.geometry);
  } catch(e) {
    showError('Error al calcular la ruta √≥ptima.'); setStatus('Error');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INFO PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showInfo(title, km, min, stops, steps) {
  document.getElementById('info-panel').style.display = '';
  document.getElementById('loading-indicator').style.display = 'none';
  const content = document.getElementById('info-content');
  content.style.display = '';
  const h = Math.floor(min/60), m = min%60;
  const timeStr = h > 0 ? `${h}h ${m}min` : `${m} min`;
  let stopsHtml = stops.map((s,i) => {
    const isOrigin=i===0, isLast=i===stops.length-1;
    const color = isOrigin?'#ff6d00':isLast?'#d32f2f':'#888';
    return `<div class="stop-row"><div class="stop-dot" style="background:${color};box-shadow:0 0 5px ${color};"></div><span>${s.name}</span>${s.km?`<span class="stop-km">${s.km} km</span>`:''}</div>`;
  }).join('');
  let stepsHtml = '';
  if (steps && steps.length) {
    stepsHtml = `<div class="section-label" style="margin-top:12px;margin-bottom:8px;">Indicaciones</div><ul class="steps-list">${steps.slice(0,12).map((s,i)=>`<li class="step-item"><div class="step-n">${i+1}</div><div><div>${s.maneuver?.instruction||s.name||'Contin√∫a'}</div><div class="step-d">${(s.distance/1000).toFixed(2)} km ¬∑ ${Math.round(s.duration/60)} min</div></div></li>`).join('')}${steps.length>12?`<li class="step-item"><div class="step-n">‚Ä¶</div><div style="color:var(--muted)">+${steps.length-12} pasos m√°s</div></li>`:''}</ul>`;
  }
  content.innerHTML = `<div class="info-title">${title}</div><div class="info-stats"><div class="stat-box"><div class="stat-val">${km}<span> km</span></div><div class="stat-label">Distancia</div></div><div class="stat-box"><div class="stat-val">${timeStr}</div><div class="stat-label">Tiempo</div></div></div><div class="section-label">Paradas</div>${stopsHtml}${stepsHtml}`;
}

function showLoading() {
  document.getElementById('info-panel').style.display = '';
  document.getElementById('loading-indicator').style.display = '';
  document.getElementById('info-content').style.display = 'none';
}

function showError(msg) {
  document.getElementById('info-panel').style.display = '';
  document.getElementById('loading-indicator').style.display = 'none';
  const c = document.getElementById('info-content');
  c.style.display = '';
  c.innerHTML = `<div style="background:rgba(211,47,47,0.1);border:1px solid rgba(211,47,47,0.3);border-radius:8px;padding:12px;font-size:12px;color:#ef9a9a;line-height:1.6;">${msg}</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawRoute(geometry, color, animated=false) {
  routeLayer = L.geoJSON(geometry, { style:{ color, weight:5, opacity:0.9, dashArray:animated?'12 8':null, lineCap:'round' }}).addTo(map);
}
function fitRoute(geometry) { map.fitBounds(L.geoJSON(geometry).getBounds(), { padding:[40,40] }); }
function clearRoute() { if (routeLayer) { map.removeLayer(routeLayer); routeLayer=null; } }

window.clearAll = function() {
  clearRoute(); setActiveRouteBtn(null);
  document.getElementById('info-panel').style.display='none';
  setStatus('Mapa limpiado');
  const base = state.bases.find(b=>b.id===state.activeBaseId);
  if (base) map.setView([base.coords[1], base.coords[0]], 10);
}

function setActiveRouteBtn(id) {
  document.querySelectorAll('.route-btn').forEach(b=>b.classList.remove('active'));
  if (id) document.getElementById(id)?.classList.add('active');
}

function setStatus(msg) { document.getElementById('status-msg').textContent = msg; }

function clearDistances() {
  state.destinations.forEach(d => {
    const el = document.getElementById('dist-' + d.id);
    if (el) el.textContent = 'Calculando...';
  });
}

async function preloadDistances() {
  const base = state.bases.find(b => b.id === state.activeBaseId);
  if (!base) return;
  for (let dest of state.destinations) {
    try {
      const r = await getRoute([base.coords, dest.coords]);
      const km = (r.distance/1000).toFixed(1);
      const min = Math.round(r.duration/60);
      const el = document.getElementById('dist-' + dest.id);
      if (el) el.textContent = `${km} km ¬∑ ${min} min`;
    } catch(e) {
      const el = document.getElementById('dist-' + dest.id);
      if (el) el.textContent = 'No disponible';
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.switchTab = function(tab) {
  ['routes','bases','dests'].forEach(t => {
    document.getElementById('tab-' + t).classList.toggle('active', t===tab);
    document.getElementById('tabBtn-' + t).classList.toggle('active', t===tab);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SIDEBAR TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.toggleSidebar = function() {
  const sidebar   = document.getElementById('sidebar');
  const tab       = document.getElementById('toggle-tab');
  const statusbar = document.getElementById('statusbar');
  const isOpen    = !sidebar.classList.contains('collapsed');
  if (isOpen) {
    sidebar.classList.add('collapsed'); tab.classList.add('open');
    tab.querySelector('.arrow').textContent='‚ñ∂'; statusbar.classList.add('expanded');
  } else {
    sidebar.classList.remove('collapsed'); tab.classList.remove('open');
    tab.querySelector('.arrow').textContent='‚óÄ'; statusbar.classList.remove('expanded');
  }
  setTimeout(() => map.invalidateSize(), 370);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER ALL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll() {
  renderRoutesTab();
  renderBasesTab();
  renderDestsTab();
  renderMarkers();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT ‚Äî escuchar Firestore en tiempo real
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
if (window.innerWidth < 600) {
  document.getElementById('sidebar').classList.add('collapsed');
  document.getElementById('toggle-tab').classList.add('open');
  document.getElementById('toggle-tab').querySelector('.arrow').textContent = '‚ñ∂';
  document.getElementById('statusbar').classList.add('expanded');
}

setStatus("‚è≥ Conectando con Firebase...");

// Escucha en tiempo real ‚Äî si no existe el doc, usa valores por defecto y los guarda
onSnapshot(STATE_DOC, async (snap) => {
  if (snap.exists()) {
    const data = snap.data();
    state.bases        = data.bases        || state.bases;
    state.destinations = data.destinations || state.destinations;
    state.activeBaseId = data.activeBaseId || state.activeBaseId;
  } else {
    // Primera vez: guardar los datos por defecto en Firestore
    await saveState();
  }
  renderAll();
  clearDistances();
  preloadDistances();
  if (!_firebaseReady) {
    _firebaseReady = true;
    setStatus("‚úÖ Conectado a Firebase ‚Äî datos en tiempo real");
    setTimeout(() => setStatus("Selecciona una ruta para comenzar"), 3000);
  }
}, (error) => {
  console.error("Error Firestore:", error);
  setStatus("‚ö†Ô∏è Sin conexi√≥n a Firebase ‚Äî modo local");
  renderAll();
  preloadDistances();
});

</script>
</body>
</html>
