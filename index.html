<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GAS EXPRESS â€” Sistema de Rutas</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=Barlow:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --red:      #d32f2f;
  --red-dark: #8b0000;
  --red-glow: rgba(211,47,47,0.3);
  --red-dim:  rgba(211,47,47,0.12);
  --bg:       #111111;
  --surface:  #1a1a1a;
  --surface2: #222222;
  --border:   #2e2e2e;
  --text:     #f0f0f0;
  --muted:    #888;
  --orange:   #ff6d00;
  --green:    #00c853;
}

body {
  font-family: 'Barlow', sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* â”€â”€ SIDEBAR â”€â”€ */
#sidebar {
  width: 280px;
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  flex-shrink: 0;
  position: relative;
  z-index: 1000;
  transition: width 0.35s cubic-bezier(0.4,0,0.2,1);
}
#sidebar.collapsed {
  width: 0;
  border-right: none;
}

/* PestaÃ±a flotante */
#toggle-tab {
  position: absolute;
  top: 50%;
  left: 280px;
  transform: translateY(-50%);
  width: 26px;
  height: 60px;
  background: var(--red);
  border: none;
  border-radius: 0 10px 10px 0;
  cursor: pointer;
  z-index: 1001;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: left 0.35s cubic-bezier(0.4,0,0.2,1), background 0.2s;
  box-shadow: 3px 0 14px rgba(0,0,0,0.5);
}
#toggle-tab:hover { background: #b71c1c; }
#toggle-tab .arrow {
  color: #fff;
  font-size: 13px;
  transition: transform 0.35s;
  pointer-events: none;
  line-height: 1;
}
#toggle-tab.open { left: 0; }
#toggle-tab.open .arrow { transform: rotate(180deg); }

.sidebar-header {
  background: var(--red-dark);
  padding: 20px 16px 16px;
  border-bottom: 3px solid var(--red);
  position: relative;
  overflow: hidden;
}
.sidebar-header::before {
  content: '';
  position: absolute;
  top: -20px; right: -20px;
  width: 100px; height: 100px;
  background: var(--red-glow);
  border-radius: 50%;
  filter: blur(30px);
}

.brand {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 30px;
  font-weight: 800;
  letter-spacing: 3px;
  color: #fff;
  line-height: 1;
}
.brand-sub {
  font-size: 10px;
  letter-spacing: 4px;
  text-transform: uppercase;
  color: rgba(255,255,255,0.55);
  margin-top: 3px;
}

.origin-badge {
  margin-top: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  padding: 8px 10px;
}
.origin-dot {
  width: 10px; height: 10px;
  border-radius: 50%;
  background: var(--orange);
  box-shadow: 0 0 8px var(--orange);
  flex-shrink: 0;
}
.origin-text { font-size: 12px; color: rgba(255,255,255,0.8); line-height: 1.3; }
.origin-text strong { display: block; font-size: 11px; color: rgba(255,255,255,0.45); font-weight: 400; letter-spacing: 1px; text-transform: uppercase; }

/* Scrollable body */
.sidebar-body {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}
.sidebar-body::-webkit-scrollbar { width: 4px; }
.sidebar-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.section-label {
  font-size: 9px;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 10px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--border);
}

/* Route buttons */
.route-btn {
  width: 100%;
  background: var(--surface2);
  color: var(--text);
  border: 1px solid var(--border);
  padding: 12px 14px;
  margin-bottom: 8px;
  cursor: pointer;
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 16px;
  font-weight: 600;
  letter-spacing: 1px;
  border-radius: 8px;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 10px;
  text-align: left;
  position: relative;
  overflow: hidden;
}
.route-btn::after {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 3px;
  background: var(--red);
  opacity: 0;
  transition: opacity 0.2s;
}
.route-btn:hover { background: #2a2a2a; border-color: var(--red); transform: translateX(2px); }
.route-btn:hover::after { opacity: 1; }
.route-btn.active { background: var(--red-dim); border-color: var(--red); }
.route-btn.active::after { opacity: 1; }

.btn-icon {
  width: 28px; height: 28px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px;
  flex-shrink: 0;
}
.btn-meta {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.btn-name { font-size: 15px; font-weight: 700; }
.btn-dist { font-size: 11px; color: var(--muted); font-family: 'Barlow', sans-serif; font-weight: 400; }

.optimized-btn {
  width: 100%;
  background: var(--red);
  color: #fff;
  border: none;
  padding: 13px;
  cursor: pointer;
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 17px;
  font-weight: 700;
  letter-spacing: 2px;
  border-radius: 8px;
  margin-top: 4px;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.optimized-btn:hover { background: #b71c1c; transform: translateY(-1px); box-shadow: 0 6px 20px var(--red-glow); }

.clear-btn {
  width: 100%;
  background: transparent;
  border: 1px solid var(--border);
  color: var(--muted);
  padding: 9px;
  cursor: pointer;
  font-family: 'Barlow', sans-serif;
  font-size: 13px;
  border-radius: 8px;
  margin-top: 8px;
  transition: all 0.2s;
}
.clear-btn:hover { border-color: #555; color: var(--text); }

/* Info panel */
#info-panel {
  margin-top: 16px;
  display: none;
}

.info-card {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 14px;
  animation: fadeIn 0.3s ease;
}
@keyframes fadeIn { from { opacity:0; transform: translateY(4px); } to { opacity:1; transform: translateY(0); } }

.info-title {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 13px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--red);
  margin-bottom: 10px;
}

.info-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 12px;
}
.stat-box {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px;
  text-align: center;
}
.stat-val {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 22px;
  font-weight: 700;
  color: var(--text);
  line-height: 1;
}
.stat-val span { font-size: 12px; color: var(--muted); }
.stat-label { font-size: 10px; color: var(--muted); margin-top: 3px; letter-spacing: 1px; text-transform: uppercase; }

.steps-list { list-style: none; }
.step-item {
  display: flex;
  gap: 10px;
  align-items: flex-start;
  padding: 7px 0;
  border-bottom: 1px solid var(--border);
  font-size: 12px;
  line-height: 1.4;
}
.step-item:last-child { border-bottom: none; }
.step-n {
  width: 18px; height: 18px; border-radius: 50%;
  background: var(--red-dim); border: 1px solid var(--red);
  display: flex; align-items: center; justify-content: center;
  font-size: 9px; color: var(--red); flex-shrink: 0; margin-top: 1px;
}
.step-d { color: var(--muted); font-size: 11px; margin-top: 2px; }

/* Spinner */
.loading {
  display: flex; flex-direction: column;
  align-items: center; gap: 10px;
  padding: 20px; color: var(--muted); font-size: 13px;
}
.spin {
  width: 28px; height: 28px;
  border: 3px solid var(--border);
  border-top-color: var(--red);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€ MAP â”€â”€ */
#map {
  flex: 1;
  z-index: 1;
}

/* Leaflet popup dark style */
.leaflet-popup-content-wrapper {
  background: var(--surface2) !important;
  color: var(--text) !important;
  border: 1px solid var(--border) !important;
  border-radius: 8px !important;
  box-shadow: 0 8px 24px rgba(0,0,0,0.6) !important;
  font-family: 'Barlow', sans-serif !important;
  font-size: 13px !important;
}
.leaflet-popup-tip { background: var(--surface2) !important; }
.leaflet-popup-close-button { color: var(--muted) !important; }

/* Custom markers */
.marker-origin {
  background: var(--orange);
  width: 14px; height: 14px;
  border-radius: 50%;
  border: 3px solid #fff;
  box-shadow: 0 0 12px var(--orange);
}
.marker-dest {
  background: var(--red);
  width: 12px; height: 12px;
  border-radius: 50%;
  border: 2px solid #fff;
  box-shadow: 0 0 8px var(--red-glow);
}

/* Status bar */
#statusbar {
  position: absolute;
  bottom: 0; left: 280px; right: 0;
  height: 32px;
  background: rgba(17,17,17,0.95);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 16px;
  gap: 16px;
  font-size: 11px;
  color: var(--muted);
  z-index: 999;
  transition: left 0.35s cubic-bezier(0.4,0,0.2,1);
}
#statusbar.expanded { left: 0; }
.status-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--red);
  animation: blink 1.5s ease-in-out infinite;
}
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

/* Route badge for waypoints */
.waypoint-badge {
  background: var(--red-dim);
  border: 1px solid var(--red);
  border-radius: 4px;
  padding: 2px 6px;
  font-size: 10px;
  color: var(--red);
  margin-top: 4px;
  display: inline-block;
}

/* â”€â”€ STOP-LIST inside info card â”€â”€ */
.stop-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 0;
  border-bottom: 1px solid var(--border);
  font-size: 12px;
}
.stop-row:last-child { border-bottom: none; }
.stop-dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
}
.stop-km { margin-left: auto; color: var(--muted); font-size: 11px; white-space: nowrap; }
</style>
</head>
<body>

<!-- SIDEBAR -->
<div id="sidebar">
  <div class="sidebar-header">
    <div class="brand">â›½ GAS EXPRESS</div>
    <div class="brand-sub">Sistema de Rutas Â· Guanajuato</div>
    <div class="origin-badge">
      <div class="origin-dot"></div>
      <div class="origin-text">
        <strong>Base Principal</strong>
        C. Zeta 101, Industrial Delta<br>LeÃ³n de los Aldama, Gto.
      </div>
    </div>
  </div>

  <div class="sidebar-body">

    <div class="section-label" style="margin-top:4px;">Rutas individuales</div>

    <button class="route-btn" id="btn-0" onclick="routeTo(0)">
      <div class="btn-icon" style="background:rgba(211,47,47,0.2);">ğŸ“</div>
      <div class="btn-meta">
        <span class="btn-name">Base Silao</span>
        <span class="btn-dist" id="dist-0">Calculando...</span>
      </div>
    </button>

    <button class="route-btn" id="btn-1" onclick="routeTo(1)">
      <div class="btn-icon" style="background:rgba(211,47,47,0.2);">ğŸ“</div>
      <div class="btn-meta">
        <span class="btn-name">Base Irapuato</span>
        <span class="btn-dist" id="dist-1">Calculando...</span>
      </div>
    </button>

    <button class="route-btn" id="btn-2" onclick="routeTo(2)">
      <div class="btn-icon" style="background:rgba(211,47,47,0.2);">ğŸ“</div>
      <div class="btn-meta">
        <span class="btn-name">Base Salamanca</span>
        <span class="btn-dist" id="dist-2">Calculando...</span>
      </div>
    </button>

    <button class="route-btn" id="btn-3" onclick="routeTo(3)">
      <div class="btn-icon" style="background:rgba(211,47,47,0.2);">ğŸ“</div>
      <div class="btn-meta">
        <span class="btn-name">Celaya</span>
        <span class="btn-dist" id="dist-3">Calculando...</span>
      </div>
    </button>

    <div class="section-label" style="margin-top:8px;">Ruta optimizada</div>

    <button class="optimized-btn" onclick="routeOptimized()">
      ğŸ—º RUTA COMPLETA Ã“PTIMA
    </button>

    <button class="clear-btn" onclick="clearAll()">âœ• Limpiar mapa</button>

    <!-- Info panel -->
    <div id="info-panel">
      <div class="section-label" style="margin-top:16px;">Resultado</div>
      <div class="info-card" id="info-card">
        <div class="loading" id="loading-indicator">
          <div class="spin"></div>
          Calculando ruta...
        </div>
        <div id="info-content" style="display:none;"></div>
      </div>
    </div>

  </div>
</div>

<!-- TOGGLE TAB -->
<button id="toggle-tab" onclick="toggleSidebar()" title="Abrir/cerrar menÃº">
  <span class="arrow">â—€</span>
</button>

<!-- MAP -->
<div id="map"></div>

<!-- STATUS BAR -->
<div id="statusbar">
  <span><span class="status-dot"></span> OSRM Online</span>
  <span id="status-msg">Selecciona una ruta para comenzar</span>
</div>

<script>

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ORIGIN = {
  name: "GAS EXPRESS â€” LeÃ³n",
  address: "C. Zeta 101, Industrial Delta, LeÃ³n de los Aldama",
  coords: [-101.6581, 21.1019]   // [lng, lat]  â€” Industrial Delta, LeÃ³n
};

const DESTINATIONS = [
  { name: "Base Silao",     coords: [-101.4284, 20.9551], color: "#ef5350" },
  { name: "Base Irapuato",  coords: [-101.3412, 20.6764], color: "#ef5350" },
  { name: "Base Salamanca", coords: [-101.1960, 20.5697], color: "#ef5350" },
  { name: "Celaya",         coords: [-100.8175, 20.5238], color: "#ef5350" },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAPA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const map = L.map('map', { zoomControl: false }).setView(
  [ORIGIN.coords[1], ORIGIN.coords[0]], 10
);

L.control.zoom({ position: 'bottomright' }).addTo(map);

// Tile oscuro
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: 'Â© OpenStreetMap, Â© CartoDB',
  maxZoom: 18,
}).addTo(map);

// Marcador origen â€” Ã­cono personalizado
const originIcon = L.divIcon({
  html: `<div style="
    background:#ff6d00;width:16px;height:16px;
    border-radius:50%;border:3px solid #fff;
    box-shadow:0 0 14px #ff6d00,0 0 4px rgba(0,0,0,0.8);
  "></div>`,
  className: '', iconAnchor: [8, 8]
});

L.marker([ORIGIN.coords[1], ORIGIN.coords[0]], { icon: originIcon })
  .addTo(map)
  .bindPopup(`<strong style="color:#ff6d00">ğŸ  ${ORIGIN.name}</strong><br><small>${ORIGIN.address}</small>`);

// Marcadores destinos
DESTINATIONS.forEach((dest, i) => {
  const icon = L.divIcon({
    html: `<div style="
      background:#d32f2f;width:12px;height:12px;
      border-radius:50%;border:2px solid #fff;
      box-shadow:0 0 10px rgba(211,47,47,0.7);
      display:flex;align-items:center;justify-content:center;
    "></div>`,
    className: '', iconAnchor: [6, 6]
  });
  L.marker([dest.coords[1], dest.coords[0]], { icon })
    .addTo(map)
    .bindPopup(`<strong style="color:#ef5350">ğŸ“ ${dest.name}</strong>`);
});

let routeLayer = null;
let activeBtn  = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FETCH RUTA OSRM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function getRoute(coordsArray) {
  const str = coordsArray.map(c => c.join(",")).join(";");
  const url  = `https://router.project-osrm.org/route/v1/driving/${str}?overview=full&geometries=geojson&steps=true`;
  const res  = await fetch(url);
  const data = await res.json();
  if (!data.routes || data.routes.length === 0) throw new Error("Sin resultados");
  return data.routes[0];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOSTRAR INFO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showInfo(title, km, min, stops, steps) {
  document.getElementById('info-panel').style.display = '';
  document.getElementById('loading-indicator').style.display = 'none';
  const content = document.getElementById('info-content');
  content.style.display = '';

  const h = Math.floor(min / 60), m = min % 60;
  const timeStr = h > 0 ? `${h}h ${m}min` : `${m} min`;

  let stopsHtml = stops.map((s, i) => {
    const isOrigin = i === 0;
    const isLast   = i === stops.length - 1;
    const color    = isOrigin ? '#ff6d00' : isLast ? '#d32f2f' : '#888';
    return `<div class="stop-row">
      <div class="stop-dot" style="background:${color};box-shadow:0 0 5px ${color};"></div>
      <span>${s.name}</span>
      ${s.km ? `<span class="stop-km">${s.km} km</span>` : ''}
    </div>`;
  }).join('');

  let stepsHtml = '';
  if (steps && steps.length) {
    stepsHtml = `
      <div class="section-label" style="margin-top:12px;margin-bottom:8px;">Indicaciones</div>
      <ul class="steps-list">
        ${steps.slice(0, 12).map((s, i) => `
          <li class="step-item">
            <div class="step-n">${i+1}</div>
            <div>
              <div>${s.maneuver?.instruction || s.name || 'ContinÃºa'}</div>
              <div class="step-d">${(s.distance/1000).toFixed(2)} km Â· ${Math.round(s.duration/60)} min</div>
            </div>
          </li>`).join('')}
        ${steps.length > 12 ? `<li class="step-item"><div class="step-n">â€¦</div><div style="color:var(--muted)">+${steps.length-12} pasos mÃ¡s</div></li>` : ''}
      </ul>`;
  }

  content.innerHTML = `
    <div class="info-title">${title}</div>
    <div class="info-stats">
      <div class="stat-box">
        <div class="stat-val">${km}<span> km</span></div>
        <div class="stat-label">Distancia</div>
      </div>
      <div class="stat-box">
        <div class="stat-val">${timeStr}</div>
        <div class="stat-label">Tiempo</div>
      </div>
    </div>
    <div class="section-label">Paradas</div>
    ${stopsHtml}
    ${stepsHtml}
  `;
}

function showLoading() {
  document.getElementById('info-panel').style.display = '';
  document.getElementById('loading-indicator').style.display = '';
  document.getElementById('info-content').style.display = 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RUTA INDIVIDUAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function routeTo(index) {
  clearRoute();
  setActiveBtn('btn-' + index);
  showLoading();
  setStatus(`Calculando ruta a ${DESTINATIONS[index].name}...`);

  try {
    const dest  = DESTINATIONS[index];
    const route = await getRoute([ORIGIN.coords, dest.coords]);

    drawRoute(route.geometry, '#d32f2f');

    const km  = (route.distance / 1000).toFixed(1);
    const min = Math.round(route.duration / 60);

    document.getElementById('dist-' + index).textContent = `${km} km Â· ${min} min`;

    const allSteps = route.legs[0]?.steps || [];
    showInfo(
      dest.name,
      km, min,
      [{ name: ORIGIN.name }, { name: dest.name }],
      allSteps
    );

    setStatus(`${dest.name} â€” ${km} km Â· ${min} min`);
    fitRoute(route.geometry);
  } catch(e) {
    showError('Error al calcular la ruta. Verifica tu conexiÃ³n.');
    setStatus('Error de conexiÃ³n');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RUTA Ã“PTIMA (Vecino mÃ¡s cercano)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function routeOptimized() {
  clearRoute();
  setActiveBtn(null);
  showLoading();
  setStatus('Calculando ruta Ã³ptima...');

  try {
    // Nearest neighbor desde origen
    let remaining = DESTINATIONS.map((d, i) => ({ ...d, idx: i }));
    let current   = ORIGIN.coords;
    let ordered   = [{ name: ORIGIN.name, coords: current }];

    while (remaining.length > 0) {
      let nearestIdx = 0, shortest = Infinity;
      remaining.forEach((d, i) => {
        const dx = current[0] - d.coords[0];
        const dy = current[1] - d.coords[1];
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < shortest) { shortest = dist; nearestIdx = i; }
      });
      current = remaining[nearestIdx].coords;
      ordered.push(remaining[nearestIdx]);
      remaining.splice(nearestIdx, 1);
    }

    const coordsList = ordered.map(o => o.coords);
    const route = await getRoute(coordsList);

    drawRoute(route.geometry, '#d32f2f', true);

    const km  = (route.distance / 1000).toFixed(1);
    const min = Math.round(route.duration / 60);

    // Per-leg distances
    const stopsWithDist = ordered.map((o, i) => ({
      name: o.name,
      km: i < route.legs.length ? (route.legs[i].distance / 1000).toFixed(1) : null
    }));

    showInfo('Ruta Completa Ã“ptima', km, min, stopsWithDist, []);
    setStatus(`Ruta Ã³ptima: ${ordered.slice(1).map(o=>o.name).join(' â†’ ')} â€” ${km} km`);
    fitRoute(route.geometry);
  } catch(e) {
    showError('Error al calcular la ruta Ã³ptima.');
    setStatus('Error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawRoute(geometry, color, animated = false) {
  routeLayer = L.geoJSON(geometry, {
    style: {
      color,
      weight: 5,
      opacity: 0.9,
      dashArray: animated ? '12 8' : null,
      lineCap: 'round',
    }
  }).addTo(map);
}

function fitRoute(geometry) {
  const bounds = L.geoJSON(geometry).getBounds();
  map.fitBounds(bounds, { padding: [40, 40] });
}

function clearRoute() {
  if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
}

function clearAll() {
  clearRoute();
  setActiveBtn(null);
  document.getElementById('info-panel').style.display = 'none';
  setStatus('Mapa limpiado');
  map.setView([ORIGIN.coords[1], ORIGIN.coords[0]], 10);
}

function setActiveBtn(id) {
  document.querySelectorAll('.route-btn').forEach(b => b.classList.remove('active'));
  if (id) document.getElementById(id)?.classList.add('active');
}

function setStatus(msg) {
  document.getElementById('status-msg').textContent = msg;
}

function showError(msg) {
  document.getElementById('info-panel').style.display = '';
  document.getElementById('loading-indicator').style.display = 'none';
  const c = document.getElementById('info-content');
  c.style.display = '';
  c.innerHTML = `<div style="background:rgba(211,47,47,0.1);border:1px solid rgba(211,47,47,0.3);border-radius:8px;padding:12px;font-size:12px;color:#ef9a9a;line-height:1.6;">${msg}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIDEBAR TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar() {
  const sidebar   = document.getElementById('sidebar');
  const tab       = document.getElementById('toggle-tab');
  const statusbar = document.getElementById('statusbar');
  const isOpen    = !sidebar.classList.contains('collapsed');

  if (isOpen) {
    sidebar.classList.add('collapsed');
    tab.classList.add('open');
    tab.querySelector('.arrow').textContent = 'â–¶';
    statusbar.classList.add('expanded');
  } else {
    sidebar.classList.remove('collapsed');
    tab.classList.remove('open');
    tab.querySelector('.arrow').textContent = 'â—€';
    statusbar.classList.remove('expanded');
  }

  // Invalidate map size after transition
  setTimeout(() => map.invalidateSize(), 370);
}

// Auto-collapse on small screens (mobile)
if (window.innerWidth < 600) {
  document.getElementById('sidebar').classList.add('collapsed');
  document.getElementById('toggle-tab').classList.add('open');
  document.getElementById('toggle-tab').querySelector('.arrow').textContent = 'â–¶';
  document.getElementById('statusbar').classList.add('expanded');
}

// Pre-cargar distancias individuales al inicio
async function preloadDistances() {
  for (let i = 0; i < DESTINATIONS.length; i++) {
    try {
      const r = await getRoute([ORIGIN.coords, DESTINATIONS[i].coords]);
      const km  = (r.distance / 1000).toFixed(1);
      const min = Math.round(r.duration / 60);
      document.getElementById('dist-' + i).textContent = `${km} km Â· ${min} min`;
    } catch(e) {
      document.getElementById('dist-' + i).textContent = 'No disponible';
    }
  }
}

preloadDistances();

</script>
</body>
</html>
